{"version":3,"sources":["src/Sprite/SpriteWebgl.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAwBA,CAAC,UAAU,MAAM,EAAE;AACjB,cAAY,CAAC;;AAEb,MAAI,eAAe,ymBAuBjB,CAAC;;AAEH,MAAI,iBAAiB,0nCAgDnB,CAAC;;AAEH,WAAS,YAAY,CAAC,EAAE,EAAE,CAAC,EAAE,CAAC,EAAE,KAAK,EAAE,MAAM,EAAE;AAC7C,QAAI,EAAE,GAAG,CAAC,GAAG,KAAK,CAAC;AACnB,QAAI,EAAE,GAAG,CAAC,GAAG,MAAM,CAAC;AACpB,MAAE,CAAC,UAAU,CAAC,EAAE,CAAC,YAAY,EAC3B,IAAI,YAAY,CACd,CACE,CAAC,EAAE,CAAC,EACJ,EAAE,EAAE,CAAC,EACL,CAAC,EAAE,EAAE,EACL,CAAC,EAAE,EAAE,EACL,EAAE,EAAE,CAAC,EACL,EAAE,EAAE,EAAE,CACP,CACF,EACD,EAAE,CAAC,WAAW,CACf,CAAC;GACH;;AAED,WAAS,KAAK,CAAE,KAAK,EAAE;AACrB,WAAO,KAAK,GAAG,CAAC,IAAI,CAAC,AAAC,KAAK,GAAG,CAAC,GAAI,KAAK,CAAA,KAAM,CAAC,CAAC;GACjD;;AAGD,QAAM,CAAC,KAAK;iBAAS,KAAK;;aAET,mBAAG;AAChB,YAAI,MAAM,GAAG,QAAQ,CAAC,aAAa,CAAC,QAAQ,CAAC,CAAC;AAC9C,YAAI,EAAE,GAAG,MAAM,CAAC,UAAU,CAAC,OAAO,EAAE,EAAC,qBAAqB,EAAE,IAAI,EAAC,CAAC,IAC7D,MAAM,CAAC,UAAU,CAAC,oBAAoB,EAAE,EAAC,qBAAqB,EAAE,IAAI,EAAC,CAAC,CAAC;AAC5E,YAAI,EAAE,EAAE;AACN,iBAAO,IAAI,CAAC;SACb;AACD,eAAO,KAAK,CAAC;OACd;;;AAEW,aAZO,KAAK,CAYX,KAAK,EAAE,MAAM,EAAE;4BAZT,KAAK;;AAatB,UAAI,MAAM,GAAG,QAAQ,CAAC,aAAa,CAAC,QAAQ,CAAC,CAAC;AAC9C,YAAM,CAAC,KAAK,GAAG,KAAK,IAAI,GAAG,CAAC;AAC5B,YAAM,CAAC,MAAM,GAAG,MAAM,IAAI,GAAG,CAAC;;AAE9B,UAAI,CAAC,MAAM,GAAG,CAAC,CAAC;AAChB,UAAI,CAAC,QAAQ,GAAG,EAAE,CAAC;AACnB,UAAI,CAAC,aAAa,GAAG,IAAI,GAAG,EAAE,CAAC;;AAE/B,UAAI,EAAE,GAAG,MAAM,CAAC,UAAU,CAAC,OAAO,CAAC,IAAI,MAAM,CAAC,UAAU,CAAC,oBAAoB,CAAC,CAAC;;AAE/E,UAAI,CAAC,EAAE,EAAE;AACP,cAAM,IAAI,KAAK,CAAC,qCAAqC,CAAC,CAAC;OACxD;;AAED,QAAE,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAC,EAAE,MAAM,CAAC,KAAK,EAAE,MAAM,CAAC,MAAM,CAAC,CAAC;;AAE/C,UAAI,aAAa,GAAG,EAAE,CAAC,YAAY,CAAC,EAAE,CAAC,aAAa,CAAC,CAAC;AACtD,UAAI,aAAa,GAAG,EAAE,CAAC,YAAY,CAAC,EAAE,CAAC,eAAe,CAAC,CAAC;AACxD,QAAE,CAAC,YAAY,CAAC,aAAa,EAAE,eAAe,CAAC,CAAC;AAChD,QAAE,CAAC,YAAY,CAAC,aAAa,EAAE,iBAAiB,CAAC,CAAC;AAClD,QAAE,CAAC,aAAa,CAAC,aAAa,CAAC,CAAC;AAChC,QAAE,CAAC,aAAa,CAAC,aAAa,CAAC,CAAC;;AAEhC,UAAI,OAAO,GAAG,EAAE,CAAC,aAAa,EAAE,CAAC;AACjC,QAAE,CAAC,YAAY,CAAC,OAAO,EAAE,aAAa,CAAC,CAAC;AACxC,QAAE,CAAC,YAAY,CAAC,OAAO,EAAE,aAAa,CAAC,CAAC;;AAExC,QAAE,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;AACxB,QAAE,CAAC,UAAU,CAAC,OAAO,CAAC,CAAC;;AAEvB,QAAE,CAAC,SAAS,CAAC,EAAE,CAAC,SAAS,EAAE,EAAE,CAAC,mBAAmB,CAAC,CAAC;AACnD,QAAE,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,CAAC;;AAEpB,aAAO,CAAC,GAAG,CAAC,cAAc,CAAC,CAAC;;AAE5B,aAAO,CAAC,GAAG,CAAC,2BAA2B,EAAE,EAAE,CAAC,YAAY,CAAC,EAAE,CAAC,gBAAgB,CAAC,CAAC,CAAC;;AAE/E,UAAI,gBAAgB,GAAG,EAAE,CAAC,iBAAiB,CAAC,OAAO,EAAE,UAAU,CAAC,CAAC;AACjE,UAAI,gBAAgB,GAAG,EAAE,CAAC,iBAAiB,CAAC,OAAO,EAAE,YAAY,CAAC,CAAC;AACnE,UAAI,kBAAkB,GAAG,EAAE,CAAC,kBAAkB,CAAC,OAAO,EAAE,YAAY,CAAC,CAAC;AACtE,UAAI,YAAY,GAAG,EAAE,CAAC,kBAAkB,CAAC,OAAO,EAAE,MAAM,CAAC,CAAC;AAC1D,UAAI,kBAAkB,GAAG,EAAE,CAAC,kBAAkB,CAAC,OAAO,EAAE,YAAY,CAAC,CAAC;AACtE,UAAI,gBAAgB,GAAG,EAAE,CAAC,kBAAkB,CAAC,OAAO,EAAE,UAAU,CAAC,CAAC;AAClE,UAAI,aAAa,GAAG,EAAE,CAAC,kBAAkB,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;;AAE5D,UAAI,CAAC,iBAAiB,GAAG,gBAAgB,CAAC;AAC1C,UAAI,CAAC,iBAAiB,GAAG,gBAAgB,CAAC;AAC1C,UAAI,CAAC,mBAAmB,GAAG,kBAAkB,CAAC;AAC9C,UAAI,CAAC,aAAa,GAAG,YAAY,CAAC;AAClC,UAAI,CAAC,mBAAmB,GAAG,kBAAkB,CAAC;AAC9C,UAAI,CAAC,iBAAiB,GAAG,gBAAgB,CAAC;AAC1C,UAAI,CAAC,cAAc,GAAG,aAAa,CAAC;;AAEpC,QAAE,CAAC,SAAS,CAAC,kBAAkB,EAAE,MAAM,CAAC,KAAK,EAAE,MAAM,CAAC,MAAM,CAAC,CAAC;;AAE9D,UAAI,cAAc,GAAG,EAAE,CAAC,YAAY,EAAE,CAAC;AACvC,QAAE,CAAC,UAAU,CAAC,EAAE,CAAC,YAAY,EAAE,cAAc,CAAC,CAAC;AAC/C,QAAE,CAAC,uBAAuB,CAAC,gBAAgB,CAAC,CAAC;AAC7C,QAAE,CAAC,mBAAmB,CAAC,gBAAgB,EAAE,CAAC,EAAE,EAAE,CAAC,KAAK,EAAE,KAAK,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC;;AAEnE,UAAI,MAAM,GAAG,EAAE,CAAC,YAAY,EAAE,CAAC;;AAE/B,kBAAY,CAAC,EAAE,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC;;AAE7B,UAAI,CAAC,eAAe,GAAG,cAAc,CAAC;AACtC,UAAI,CAAC,OAAO,GAAG,MAAM,CAAC;;AAEtB,UAAI,CAAC,OAAO,GAAG,MAAM,CAAC;AACtB,UAAI,CAAC,GAAG,GAAG,EAAE,CAAC;KACf;;iBAlFkB,KAAK;;aA4FjB,gBAAC,IAAI,EAAE,KAAK,EAAE;AACnB,YAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,GAAG,KAAK,CAAC;OAC7B;;;aAEa,uBAAC,EAAE,EAAE,KAAK,EAAE;;;AAGxB,YAAI,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,KAAK,CAAC,EAAE;AACjC,iBAAO,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;SACtC,MAAM;AACL,cAAI,OAAO,GAAG,EAAE,CAAC,aAAa,EAAE,CAAC;AACjC,YAAE,CAAC,WAAW,CAAC,EAAE,CAAC,UAAU,EAAE,OAAO,CAAC,CAAC;AACvC,YAAE,CAAC,UAAU,CAAC,EAAE,CAAC,UAAU,EAAE,CAAC,EAAG,EAAE,CAAC,IAAI,EAAG,EAAE,CAAC,IAAI,EAAE,EAAE,CAAC,aAAa,EAAE,KAAK,CAAC,CAAC;AAC7E,YAAE,CAAC,aAAa,CAAC,EAAE,CAAC,UAAU,EAAE,EAAE,CAAC,cAAc,EAAE,EAAE,CAAC,aAAa,CAAC,CAAC;AACrE,YAAE,CAAC,aAAa,CAAC,EAAE,CAAC,UAAU,EAAE,EAAE,CAAC,cAAc,EAAE,EAAE,CAAC,aAAa,CAAC,CAAC;AACrE,YAAE,CAAC,aAAa,CAAC,EAAE,CAAC,UAAU,EAAE,EAAE,CAAC,kBAAkB,EAAE,EAAE,CAAC,MAAM,CAAC,CAAC;;;AAGlE,cAAI,KAAK,CAAC,KAAK,CAAC,KAAK,CAAC,IAAI,KAAK,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE;AAC7C,cAAE,CAAC,aAAa,CAAC,EAAE,CAAC,UAAU,EAAE,EAAE,CAAC,kBAAkB,EAAE,EAAE,CAAC,oBAAoB,CAAC,CAAC;AAChF,cAAE,CAAC,cAAc,CAAC,EAAE,CAAC,UAAU,CAAC,CAAC;WAClC,MAAM;AACL,cAAE,CAAC,aAAa,CAAC,EAAE,CAAC,UAAU,EAAE,EAAE,CAAC,kBAAkB,EAAE,EAAE,CAAC,MAAM,CAAC,CAAC;WACnE;;AAED,cAAI,CAAC,aAAa,CAAC,GAAG,CAAC,KAAK,EAAE,OAAO,CAAC,CAAC;AACvC,YAAE,CAAC,WAAW,CAAC,EAAE,CAAC,UAAU,EAAE,IAAI,CAAC,CAAC;AACpC,iBAAO,OAAO,CAAC;SAChB;OACF;;;aAES,mBAAC,KAAK,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE;AAChD,YAAI,EAAE,GAAG,IAAI,CAAC,GAAG,CAAC;;AAElB,YAAI,CAAC,KAAK,CAAC,KAAK,IAAI,CAAC,KAAK,CAAC,MAAM,IAAI,KAAK,CAAC,KAAK,IAAI,CAAC,IAAI,KAAK,CAAC,MAAM,IAAI,CAAC,EAAE;AAC1E,iBAAO,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;AACrB,gBAAM,IAAI,KAAK,CAAC,yBAAyB,CAAC,CAAC;SAC5C;;AAED,YAAI,SAAS,CAAC,MAAM,IAAI,CAAC,EAAE;;SAE1B,MAAM,IAAI,SAAS,CAAC,MAAM,IAAI,CAAC,EAAE;;AAEhC,cAAE,GAAG,EAAE,CAAC;AACR,cAAE,GAAG,EAAE,CAAC;AACR,cAAE,GAAG,EAAE,CAAC;AACR,cAAE,GAAG,EAAE,CAAC;AACR,cAAE,GAAG,CAAC,CAAC;AACP,cAAE,GAAG,CAAC,CAAC;AACP,cAAE,GAAG,KAAK,CAAC,KAAK,CAAC;AACjB,cAAE,GAAG,KAAK,CAAC,MAAM,CAAC;WACnB,MAAM,IAAI,SAAS,CAAC,MAAM,IAAI,CAAC,EAAE;;AAEhC,cAAE,GAAG,EAAE,CAAC;AACR,cAAE,GAAG,EAAE,CAAC;AACR,cAAE,GAAG,KAAK,CAAC,KAAK,CAAC;AACjB,cAAE,GAAG,KAAK,CAAC,MAAM,CAAC;AAClB,cAAE,GAAG,CAAC,CAAC;AACP,cAAE,GAAG,CAAC,CAAC;AACP,cAAE,GAAG,KAAK,CAAC,KAAK,CAAC;AACjB,cAAE,GAAG,KAAK,CAAC,MAAM,CAAC;WACnB,MAAM;AACL,mBAAO,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC;AACzB,kBAAM,IAAI,KAAK,CAAC,6BAA6B,CAAC,CAAC;WAChD;;AAED,YAAI,OAAO,GAAG,IAAI,CAAC,aAAa,CAAC,EAAE,EAAE,KAAK,CAAC,CAAC;;AAE5C,UAAE,CAAC,WAAW,CAAC,EAAE,CAAC,UAAU,EAAE,OAAO,CAAC,CAAC;;AAEvC,UAAE,CAAC,SAAS,CAAC,IAAI,CAAC,aAAa,EAAE,EAAE,GAAC,KAAK,CAAC,KAAK,EAAE,EAAE,GAAC,KAAK,CAAC,MAAM,EAAE,EAAE,GAAC,KAAK,CAAC,KAAK,EAAE,EAAE,GAAC,KAAK,CAAC,MAAM,CAAC,CAAC;;;;AAInG,YAAI,IAAI,CAAC,QAAQ,CAAC,YAAY,CAAC,EAAE;AAC/B,YAAE,CAAC,SAAS,CAAC,IAAI,CAAC,mBAAmB,EAAE,IAAI,CAAC,QAAQ,CAAC,YAAY,CAAC,CAAC,CAAC;SACrE,MAAM;AACL,YAAE,CAAC,SAAS,CAAC,IAAI,CAAC,mBAAmB,EAAE,GAAG,CAAC,CAAC;SAC7C;;AAED,YAAI,IAAI,CAAC,QAAQ,CAAC,UAAU,CAAC,EAAE;AAC7B,YAAE,CAAC,SAAS,CAAC,IAAI,CAAC,iBAAiB,EAAE,IAAI,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC,CAAC;SACjE,MAAM;AACL,YAAE,CAAC,SAAS,CAAC,IAAI,CAAC,iBAAiB,EAAE,GAAG,CAAC,CAAC;SAC3C;;AAED,UAAE,CAAC,SAAS,CAAC,IAAI,CAAC,cAAc,EAAE,IAAI,CAAC,MAAM,CAAC,CAAC;;AAE/C,UAAE,CAAC,UAAU,CAAC,EAAE,CAAC,YAAY,EAAE,IAAI,CAAC,OAAO,CAAC,CAAC;AAC7C,UAAE,CAAC,uBAAuB,CAAC,IAAI,CAAC,iBAAiB,CAAC,CAAC;AACnD,UAAE,CAAC,mBAAmB,CAAC,IAAI,CAAC,iBAAiB,EAAE,CAAC,EAAE,EAAE,CAAC,KAAK,EAAE,KAAK,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC;;AAEzE,oBAAY,CAAC,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,CAAC,CAAC;;;AAGjC,UAAE,CAAC,UAAU,CAAC,EAAE,CAAC,SAAS,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC;OACnC;;;aAEK,iBAAG;AACP,YAAI,EAAE,GAAG,IAAI,CAAC,GAAG,CAAC;AAClB,UAAE,CAAC,UAAU,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC;AAC1B,UAAE,CAAC,KAAK,CAAC,EAAE,CAAC,gBAAgB,CAAC,CAAC;OAC/B;;;WA9GS,eAAG;AACX,eAAO,IAAI,CAAC,MAAM,CAAC;OACpB;WAES,aAAC,KAAK,EAAE;AAChB,YAAI,CAAC,MAAM,GAAG,KAAK,CAAC;OACrB;;;WA0GS,eAAG;AACX,eAAO,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC;OAC3B;WAES,aAAC,KAAK,EAAE;AAChB,YAAI,KAAK,IAAI,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE;AAC/B,cAAI,CAAC,OAAO,CAAC,KAAK,GAAG,KAAK,CAAC;AAC3B,cAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAC,EAAE,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;AACjE,cAAI,CAAC,GAAG,CAAC,SAAS,CAAC,kBAAkB,EAAE,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;SACjF;OACF;;;WAEU,eAAG;AACZ,eAAO,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC;OAC5B;WAEU,aAAC,KAAK,EAAE;AACjB,YAAI,KAAK,IAAI,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE;AAChC,cAAI,CAAC,OAAO,CAAC,MAAM,GAAG,KAAK,CAAC;AAC5B,cAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAC,EAAE,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;AACjE,cAAI,CAAC,GAAG,CAAC,SAAS,CAAC,kBAAkB,EAAE,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;SACjF;OACF;;;WAEU,eAAG;AACZ,eAAO,IAAI,CAAC,OAAO,CAAC;OACrB;WAEU,aAAC,KAAK,EAAE;AACjB,cAAM,IAAI,KAAK,CAAC,kCAAkC,CAAC,CAAC;OACrD;;;WAlOkB,KAAK;MAqOzB,CAAC;CAEH,CAAA,CAAE,MAAM,CAAC,CAAC","file":"src/Sprite/SpriteWebgl.js","sourcesContent":["/*\n\n2D Game Sprite Library, Built using JavaScript ES6\nCopyright (C) 2015 qhduan(http://qhduan.com)\n\nThis program is free software: you can redistribute it and/or modify\nit under the terms of the GNU General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU General Public License for more details.\n\nYou should have received a copy of the GNU General Public License\nalong with this program.  If not, see <http://www.gnu.org/licenses/>.\n\n*/\n\n/// @file SpriteWebgl.js\n/// @namespace Sprite\n/// class Sprite.Webgl\n\n(function (Sprite) {\n  \"use strict\";\n\n  var vertexShaderSrc = `\n  attribute vec2 position;\n  attribute vec2 a_texCoord;\n\n  uniform vec2 resolution;\n\n  varying vec2 texCoord;\n\n  void main() {\n     // convert the rectangle from pixels to 0.0 to 1.0\n     vec2 zeroToOne = position / resolution;\n\n     // convert from 0->1 to 0->2\n     vec2 zeroToTwo = zeroToOne * 2.0;\n\n     // convert from 0->2 to -1->+1 (clipspace)\n     vec2 clipSpace = zeroToTwo - 1.0;\n\n     gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n\n     // pass the texCoord to the fragment shader\n     // The GPU will interpolate this value between points.\n     texCoord = a_texCoord;\n  }`;\n\n  var fragmentShaderSrc = `\n  // precision mediump float;\n  precision highp float;\n\n  // texture crop\n  uniform vec4 crop;\n\n  // texture brightness\n  uniform float brightness;\n\n  // texture alpha\n  uniform float alpha;\n\n  // texture contrast\n  uniform float contrast;\n\n  // our texture\n  uniform sampler2D image;\n\n  // the texCoords passed in from the vertex shader.\n  varying vec2 texCoord;\n\n  void main() {\n     // Look up a color from the texture.\n     // gl_FragColor = texture2D(image, texCoord);\n\n     // use crop to cut image\n     vec4 color = texture2D(\n       image,\n       vec2(texCoord.x * crop.z, texCoord.y * crop.w) + crop.xy\n     ).rgba;\n\n     // brightness and contrast's formular from https://github.com/evanw/glfx.js\n\n     // add the brightness to rgb, but not alpha (a of rgba)\n     color.xyz = color.xyz + brightness;\n\n     // apply contrast\n     if (contrast > 0.0) {\n       color.xyz = (color.xyz - 0.5) / (1.0 - contrast) + 0.5;\n     } else {\n       color.xyz = (color.xyz - 0.5) * (1.0 + contrast) + 0.5;\n     }\n\n     // apply alpha\n     color.a = color.a * alpha;\n\n     gl_FragColor = color;\n  }`;\n\n  function setRectangle(gl, x, y, width, height) {\n    var x2 = x + width;\n    var y2 = y + height;\n    gl.bufferData(gl.ARRAY_BUFFER,\n      new Float32Array(\n        [\n          x, y,\n          x2, y,\n          x, y2,\n          x, y2,\n          x2, y,\n          x2, y2\n        ]\n      ),\n      gl.STATIC_DRAW\n    );\n  }\n\n  function isPOT (value) {\n    return value > 0 && ((value - 1) & value) === 0;\n  }\n\n\n  Sprite.Webgl = class Webgl {\n\n    static support () {\n      var canvas = document.createElement(\"canvas\");\n      var gl = canvas.getContext(\"webgl\", {preserveDrawingBuffer: true})\n        || canvas.getContext(\"experimental-webgl\", {preserveDrawingBuffer: true});\n      if (gl) {\n        return true;\n      }\n      return false;\n    }\n\n    constructor (width, height) {\n      var canvas = document.createElement(\"canvas\");\n      canvas.width = width || 640;\n      canvas.height = height || 480;\n\n      this._alpha = 1;\n      this._filters = {};\n      this._textureCache = new Map();\n\n      var gl = canvas.getContext(\"webgl\") || canvas.getContext(\"experimental-webgl\");\n\n      if (!gl) {\n        throw new Error(\"Sprite.Webgl webgl is not supported\");\n      }\n\n      gl.viewport(0, 0, canvas.width, canvas.height);\n\n      var vertShaderObj = gl.createShader(gl.VERTEX_SHADER);\n      var fragShaderObj = gl.createShader(gl.FRAGMENT_SHADER);\n      gl.shaderSource(vertShaderObj, vertexShaderSrc);\n      gl.shaderSource(fragShaderObj, fragmentShaderSrc);\n      gl.compileShader(vertShaderObj);\n      gl.compileShader(fragShaderObj);\n\n      var program = gl.createProgram();\n      gl.attachShader(program, vertShaderObj);\n      gl.attachShader(program, fragShaderObj);\n\n      gl.linkProgram(program);\n      gl.useProgram(program);\n\n      gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);\n      gl.enable(gl.BLEND);\n\n      console.log(\"webgl inited\");\n\n      console.log(\"webgl, max texture size: \", gl.getParameter(gl.MAX_TEXTURE_SIZE));\n\n      var positionLocation = gl.getAttribLocation(program, \"position\");\n      var texCoordLocation = gl.getAttribLocation(program, \"a_texCoord\");\n      var resolutionLocation = gl.getUniformLocation(program, \"resolution\");\n      var cropLocation = gl.getUniformLocation(program, \"crop\");\n      var brightnessLocation = gl.getUniformLocation(program, \"brightness\");\n      var contrastLocation = gl.getUniformLocation(program, \"contrast\");\n      var alphaLocation = gl.getUniformLocation(program, \"alpha\");\n\n      this._positionLocation = positionLocation;\n      this._texCoordLocation = texCoordLocation;\n      this._resolutionLocation = resolutionLocation;\n      this._cropLocation = cropLocation;\n      this._brightnessLocation = brightnessLocation;\n      this._contrastLocation = contrastLocation;\n      this._alphaLocation = alphaLocation;\n\n      gl.uniform2f(resolutionLocation, canvas.width, canvas.height);\n\n      var texCoordBuffer = gl.createBuffer();\n      gl.bindBuffer(gl.ARRAY_BUFFER, texCoordBuffer);\n      gl.enableVertexAttribArray(texCoordLocation);\n      gl.vertexAttribPointer(texCoordLocation, 2, gl.FLOAT, false, 0, 0);\n\n      var buffer = gl.createBuffer();\n\n      setRectangle(gl, 0, 0, 1, 1);\n\n      this._texCoordBuffer = texCoordBuffer;\n      this._buffer = buffer;\n\n      this._canvas = canvas;\n      this._gl = gl;\n    }\n\n    get alpha () {\n      return this._alpha;\n    }\n\n    set alpha (value) {\n      this._alpha = value;\n    }\n\n    filter (name, value) {\n      this._filters[name] = value;\n    }\n\n    createTexture (gl, image) {\n      //var cacheIndex = imageCache.indexOf(image);\n\n      if (this._textureCache.has(image)) {\n        return this._textureCache.get(image);\n      } else {\n        var texture = gl.createTexture();\n        gl.bindTexture(gl.TEXTURE_2D, texture);\n        gl.texImage2D(gl.TEXTURE_2D, 0,  gl.RGBA,  gl.RGBA, gl.UNSIGNED_BYTE, image);\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n\n        // if image size is power of 2\n        if (isPOT(image.width) && isPOT(image.height)) {\n          gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_LINEAR);\n          gl.generateMipmap(gl.TEXTURE_2D);\n        } else {\n          gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n        }\n\n        this._textureCache.set(image, texture);\n        gl.bindTexture(gl.TEXTURE_2D, null);\n        return texture;\n      }\n    }\n\n    drawImage (image, sx, sy, sw, sh, dx, dy, dw, dh) {\n      var gl = this._gl;\n\n      if (!image.width || !image.height || image.width <= 0 || image.height <= 0) {\n        console.error(image);\n        throw new Error(\"drawImage invalid image\");\n      }\n\n      if (arguments.length == 9) {\n        // all right\n      } else if (arguments.length == 5) {\n        // drawImage (image, dx, dy, dw, dh);\n        dx = sx;\n        dy = sy;\n        dw = sw;\n        dh = sh;\n        sx = 0;\n        sy = 0;\n        sw = image.width;\n        sh = image.height;\n      } else if (arguments.length == 3) {\n        // drawImage (image, dx, dy);\n        dx = sx;\n        dy = sy;\n        dw = image.width;\n        dh = image.height;\n        sx = 0;\n        sy = 0;\n        sw = image.width;\n        sh = image.height;\n      } else {\n        console.error(arguments);\n        throw new Error(\"drawImage invalid arguments\");\n      }\n\n      var texture = this.createTexture(gl, image);\n\n      gl.bindTexture(gl.TEXTURE_2D, texture);\n      //setRectangle(gl, sx/image.width, sy/image.height, sw/image.width, sh/image.height);\n      gl.uniform4f(this._cropLocation, sx/image.width, sy/image.height, sw/image.width, sh/image.height);\n      //console.log(sx, sy, sw, sh, dx, dy, dw, dh, sx/image.width, sy/image.height, sw/image.width, sh/image.height)\n      //setRectangle(gl, 0, 0, 1, 1);\n\n      if (this._filters[\"brightness\"]) {\n        gl.uniform1f(this._brightnessLocation, this._filters[\"brightness\"]);\n      } else {\n        gl.uniform1f(this._brightnessLocation, 0.0);\n      }\n\n      if (this._filters[\"contrast\"]) {\n        gl.uniform1f(this._contrastLocation, this._filters[\"contrast\"]);\n      } else {\n        gl.uniform1f(this._contrastLocation, 0.0);\n      }\n\n      gl.uniform1f(this._alphaLocation, this._alpha);\n\n      gl.bindBuffer(gl.ARRAY_BUFFER, this._buffer);\n      gl.enableVertexAttribArray(this._positionLocation);\n      gl.vertexAttribPointer(this._positionLocation, 2, gl.FLOAT, false, 0, 0);\n\n      setRectangle(gl, dx, dy, dw, dh);\n\n      // draw\n      gl.drawArrays(gl.TRIANGLES, 0, 6);\n    }\n\n    clear () {\n      var gl = this._gl;\n      gl.clearColor(0, 0, 0, 1); // black\n      gl.clear(gl.COLOR_BUFFER_BIT);\n    }\n\n    get width () {\n      return this._canvas.width;\n    }\n\n    set width (value) {\n      if (value != this._canvas.width) {\n        this._canvas.width = value;\n        this._gl.viewport(0, 0, this._canvas.width, this._canvas.height);\n        this._gl.uniform2f(resolutionLocation, this._canvas.width, this._canvas.height);\n      }\n    }\n\n    get height () {\n      return this._canvas.height;\n    }\n\n    set height (value) {\n      if (value != this._canvas.height) {\n        this._canvas.height = value;\n        this._gl.viewport(0, 0, this._canvas.width, this._canvas.height);\n        this._gl.uniform2f(resolutionLocation, this._canvas.width, this._canvas.height);\n      }\n    }\n\n    get canvas () {\n      return this._canvas;\n    }\n\n    set canvas (value) {\n      throw new Error(\"Sprite.Webgl.canvas cannot write\");\n    }\n\n\n  };\n\n})(Sprite);\n"]}