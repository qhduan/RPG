/*

A-RPG Game, Built using JavaScript ES6
Copyright (C) 2015 qhduan(http://qhduan.com)

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

*/

"use strict";

(function () {
  "use strict";

  // 合并图片
  // 把images中的所有图片按顺序draw到一个canvas上面，然后用canvas.toDataURL返回一张叠好的图片
  function CombineHeroImage(images, width, height) {
    return new Promise(function (resolve, reject) {
      var canvas = document.createElement("canvas");
      canvas.height = height;
      canvas.width = width;
      var context = canvas.getContext("2d");
      context.clearRect(0, 0, width, height);

      var length = images.length - 1; // 最后一张图是武器
      for (var i = 0; i < length; i++) {
        var img = images[i];
        context.drawImage(img, 0, 0, img.width, img.height, 0, 0, width, height);
      }

      var withoutWeapon = null;
      var withWeapon = null;

      var promises = new Set();

      withoutWeapon = new Image();
      withoutWeapon.src = canvas.toDataURL("image/png");

      promises.add(new Promise(function (resolve, reject) {
        if (withoutWeapon.complete) {
          resolve();
        } else {
          withoutWeapon.onload = function () {
            resolve();
          };
        }
      }));

      context.drawImage(images[length], 0, 0, images[length].width, images[length].height, 0, 0, width, height);

      withWeapon = new Image();
      withWeapon.src = canvas.toDataURL("image/png");

      promises.add(new Promise(function (resolve, reject) {
        if (withWeapon.complete) {
          resolve();
        } else {
          withWeapon.onload = function () {
            resolve();
          };
        }
      }));

      // Promise es6
      Promise.all(promises).then(function () {
        resolve([withoutWeapon, withWeapon]);
      });
    });
  }

  function Check(str) {
    if (typeof str == "string" && str.length > 0) return true;
    return false;
  }

  // 把多张图片合成一张，并返回
  Game.assign("drawHero", function (heroCustom) {
    return new Promise(function (resolve, reject) {
      var BASE = "hero";
      var imageUrls = [];

      if (Check(heroCustom.sex) && Check(heroCustom.body)) {
        // 必须按顺序
        // 身体
        imageUrls.push(BASE + "/body/" + heroCustom.sex + "/" + heroCustom.body + ".png");
        // 眼睛
        if (Check(heroCustom.eyes)) imageUrls.push(BASE + "/body/" + heroCustom.sex + "/eyes/" + heroCustom.eyes + ".png");
        // 衣服
        if (Check(heroCustom.shirts)) imageUrls.push(BASE + "/shirts/" + heroCustom.sex + "/" + heroCustom.shirts + ".png");
        if (Check(heroCustom.pants)) imageUrls.push(BASE + "/pants/" + heroCustom.sex + "/" + heroCustom.pants + ".png");
        if (Check(heroCustom.shoes))
          // 盔甲
          imageUrls.push(BASE + "/shoes/" + heroCustom.sex + "/" + heroCustom.shoes + ".png");
        if (Check(heroCustom.armorchest)) imageUrls.push(BASE + "/armor/chest/" + heroCustom.sex + "/" + heroCustom.armorchest + ".png");
        if (Check(heroCustom.armorarm)) imageUrls.push(BASE + "/armor/arm/" + heroCustom.sex + "/" + heroCustom.armorarm + ".png");
        if (Check(heroCustom.armorlegs)) imageUrls.push(BASE + "/armor/legs/" + heroCustom.sex + "/" + heroCustom.armorlegs + ".png");
        if (Check(heroCustom.armorfeet)) imageUrls.push(BASE + "/armor/feet/" + heroCustom.sex + "/" + heroCustom.armorfeet + ".png");
        // 头发
        if (Check(heroCustom.hair) && Check(heroCustom.haircolor)) imageUrls.push(BASE + "/hair/" + heroCustom.sex + "/" + heroCustom.hair + "/" + heroCustom.haircolor + ".png");
        // 头
        if (Check(heroCustom.head)) imageUrls.push(BASE + "/head/" + heroCustom.sex + "/" + heroCustom.head + ".png");
        // 头盔
        if (Check(heroCustom.armorhelms)) imageUrls.push(BASE + "/armor/helms/" + heroCustom.sex + "/" + heroCustom.armorhelms + ".png");
        // 武器（包括所有武器）
        imageUrls.push(BASE + "/weapons/" + heroCustom.sex + "/weapons.png");
      }

      Sprite.load(imageUrls).then(function (data) {
        CombineHeroImage(data, heroCustom.width, heroCustom.height).then(function (data) {
          resolve(data);
        });
      });
    });
  });
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9HYW1lL0dhbWVEcmF3SGVyby5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBcUJBLENBQUMsWUFBWTtBQUNYLGNBQVksQ0FBQzs7OztBQUliLFdBQVMsZ0JBQWdCLENBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUU7QUFDaEQsV0FBTyxJQUFJLE9BQU8sQ0FBQyxVQUFVLE9BQU8sRUFBRSxNQUFNLEVBQUU7QUFDNUMsVUFBSSxNQUFNLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUM5QyxZQUFNLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztBQUN2QixZQUFNLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztBQUNyQixVQUFJLE9BQU8sR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3RDLGFBQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUM7O0FBRXZDLFVBQUksTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0FBQy9CLFdBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7QUFDL0IsWUFBSSxHQUFHLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3BCLGVBQU8sQ0FBQyxTQUFTLENBQ2YsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsR0FBRyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsTUFBTSxFQUNoQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxNQUFNLENBQ3BCLENBQUM7T0FDSDs7QUFFRCxVQUFJLGFBQWEsR0FBRyxJQUFJLENBQUM7QUFDekIsVUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDOztBQUV0QixVQUFJLFFBQVEsR0FBRyxJ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VSxDQUFDLEdBQUcsU0FBSSxVQUFVLENBQUMsSUFBSSxVQUFPLENBQUM7O0FBRTFFLFlBQUksS0FBSyxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsRUFDOUIsU0FBUyxDQUFDLElBQUksQ0FBSSxJQUFJLHFCQUFnQixVQUFVLENBQUMsR0FBRyxTQUFJLFVBQVUsQ0FBQyxVQUFVLFVBQU8sQ0FBQzs7QUFFdkYsaUJBQVMsQ0FBQyxJQUFJLENBQUksSUFBSSxpQkFBWSxVQUFVLENBQUMsR0FBRyxrQkFBZSxDQUFDO09BQ2pFOztBQUVELFlBQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsSUFBSSxFQUFFO0FBQzFDLHdCQUFnQixDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsS0FBSyxFQUFFLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxJQUFJLEVBQUU7QUFDL0UsaUJBQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNmLENBQUMsQ0FBQztPQUNKLENBQUMsQ0FBQztLQUNKLENBQUMsQ0FBQztHQUdKLENBQUMsQ0FBQztDQUdKLENBQUEsRUFBRyxDQUFDIiwiZmlsZSI6IkdhbWVEcmF3SGVyby5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5cbkEtUlBHIEdhbWUsIEJ1aWx0IHVzaW5nIEphdmFTY3JpcHQgRVM2XG5Db3B5cmlnaHQgKEMpIDIwMTUgcWhkdWFuKGh0dHA6Ly9xaGR1YW4uY29tKVxuXG5UaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbnRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4oYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuXG5UaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbmJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG5NRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG5HTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuXG5Zb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZVxuYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uXG5cbiovXG5cblxuKGZ1bmN0aW9uICgpIHtcbiAgXCJ1c2Ugc3RyaWN0XCI7XG5cbiAgLy8g5ZCI5bm25Zu+54mHXG4gIC8vIOaKimltYWdlc+S4reeahOaJgOacieWbvueJh+aMiemhuuW6j2RyYXfliLDkuIDkuKpjYW52YXPkuIrpnaLvvIznhLblkI7nlKhjYW52YXMudG9EYXRhVVJM6L+U5Zue5LiA5byg5Y+g5aW955qE5Zu+54mHXG4gIGZ1bmN0aW9uIENvbWJpbmVIZXJvSW1hZ2UgKGltYWdlcywgd2lkdGgsIGhlaWdodCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICBsZXQgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImNhbnZhc1wiKTtcbiAgICAgIGNhbnZhcy5oZWlnaHQgPSBoZWlnaHQ7XG4gICAgICBjYW52YXMud2lkdGggPSB3aWR0aDtcbiAgICAgIGxldCBjb250ZXh0ID0gY2FudmFzLmdldENvbnRleHQoXCIyZFwiKTtcbiAgICAgIGNvbnRleHQuY2xlYXJSZWN0KDAsIDAsIHdpZHRoLCBoZWlnaHQpO1xuXG4gICAgICBsZXQgbGVuZ3RoID0gaW1hZ2VzLmxlbmd0aCAtIDE7IC8vIOacgOWQjuS4gOW8oOWbvuaYr+atpuWZqFxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykge1xuICAgICAgICBsZXQgaW1nID0gaW1hZ2VzW2ldO1xuICAgICAgICBjb250ZXh0LmRyYXdJbWFnZShcbiAgICAgICAgICBpbWcsIDAsIDAsIGltZy53aWR0aCwgaW1nLmhlaWdodCxcbiAgICAgICAgICAwLCAwLCB3aWR0aCwgaGVpZ2h0XG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGxldCB3aXRob3V0V2VhcG9uID0gbnVsbDtcbiAgICAgIGxldCB3aXRoV2VhcG9uID0gbnVsbDtcblxuICAgICAgbGV0IHByb21pc2VzID0gbmV3IFNldCgpO1xuXG4gICAgICB3aXRob3V0V2VhcG9uID0gbmV3IEltYWdlKCk7XG4gICAgICB3aXRob3V0V2VhcG9uLnNyYyA9IGNhbnZhcy50b0RhdGFVUkwoXCJpbWFnZS9wbmdcIik7XG5cbiAgICAgIHByb21pc2VzLmFkZChcbiAgICAgICAgbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgIGlmICh3aXRob3V0V2VhcG9uLmNvbXBsZXRlKSB7XG4gICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHdpdGhvdXRXZWFwb24ub25sb2FkID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICk7XG5cbiAgICAgIGNvbnRleHQuZHJhd0ltYWdlKFxuICAgICAgICBpbWFnZXNbbGVuZ3RoXSwgMCwgMCwgaW1hZ2VzW2xlbmd0aF0ud2lkdGgsIGltYWdlc1tsZW5ndGhdLmhlaWdodCxcbiAgICAgICAgMCwgMCwgd2lkdGgsIGhlaWdodFxuICAgICAgKTtcblxuICAgICAgd2l0aFdlYXBvbiA9IG5ldyBJbWFnZSgpO1xuICAgICAgd2l0aFdlYXBvbi5zcmMgPSBjYW52YXMudG9EYXRhVVJMKFwiaW1hZ2UvcG5nXCIpO1xuXG4gICAgICBwcm9taXNlcy5hZGQoXG4gICAgICAgIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgICBpZiAod2l0aFdlYXBvbi5jb21wbGV0ZSkge1xuICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB3aXRoV2VhcG9uLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICApO1xuXG4gICAgICAvLyBQcm9taXNlIGVzNiBcbiAgICAgIFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgcmVzb2x2ZShbd2l0aG91dFdlYXBvbiwgd2l0aFdlYXBvbl0pO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuXG4gIGZ1bmN0aW9uIENoZWNrIChzdHIpIHtcbiAgICBpZiAodHlwZW9mIHN0ciA9PSBcInN0cmluZ1wiICYmIHN0ci5sZW5ndGggPiAwKVxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgLy8g5oqK5aSa5byg5Zu+54mH5ZCI5oiQ5LiA5byg77yM5bm26L+U5ZueXG4gIEdhbWUuYXNzaWduKFwiZHJhd0hlcm9cIiwgZnVuY3Rpb24gKGhlcm9DdXN0b20pIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgbGV0IEJBU0UgPSBcImhlcm9cIjtcbiAgICAgIGxldCBpbWFnZVVybHMgPSBbXTtcblxuICAgICAgaWYgKENoZWNrKGhlcm9DdXN0b20uc2V4KSAmJiBDaGVjayhoZXJvQ3VzdG9tLmJvZHkpKSB7XG4gICAgICAgIC8vIOW/hemhu+aMiemhuuW6j1xuICAgICAgICAvLyDouqvkvZNcbiAgICAgICAgaW1hZ2VVcmxzLnB1c2goYCR7QkFTRX0vYm9keS8ke2hlcm9DdXN0b20uc2V4fS8ke2hlcm9DdXN0b20uYm9keX0ucG5nYCk7XG4gICAgICAgIC8vIOecvOedm1xuICAgICAgICBpZiAoQ2hlY2soaGVyb0N1c3RvbS5leWVzKSlcbiAgICAgICAgICBpbWFnZVVybHMucHVzaChgJHtCQVNFfS9ib2R5LyR7aGVyb0N1c3RvbS5zZXh9L2V5ZXMvJHtoZXJvQ3VzdG9tLmV5ZXN9LnBuZ2ApO1xuICAgICAgICAvLyDooaPmnI1cbiAgICAgICAgaWYgKENoZWNrKGhlcm9DdXN0b20uc2hpcnRzKSlcbiAgICAgICAgICBpbWFnZVVybHMucHVzaChgJHtCQVNFfS9zaGlydHMvJHtoZXJvQ3VzdG9tLnNleH0vJHtoZXJvQ3VzdG9tLnNoaXJ0c30ucG5nYCk7XG4gICAgICAgIGlmIChDaGVjayhoZXJvQ3VzdG9tLnBhbnRzKSlcbiAgICAgICAgICBpbWFnZVVybHMucHVzaChgJHtCQVNFfS9wYW50cy8ke2hlcm9DdXN0b20uc2V4fS8ke2hlcm9DdXN0b20ucGFudHN9LnBuZ2ApO1xuICAgICAgICBpZiAoQ2hlY2soaGVyb0N1c3RvbS5zaG9lcykpXG4gICAgICAgIC8vIOeblOeUslxuICAgICAgICAgIGltYWdlVXJscy5wdXNoKGAke0JBU0V9L3Nob2VzLyR7aGVyb0N1c3RvbS5zZXh9LyR7aGVyb0N1c3RvbS5zaG9lc30ucG5nYCk7XG4gICAgICAgIGlmIChDaGVjayhoZXJvQ3VzdG9tLmFybW9yY2hlc3QpKVxuICAgICAgICAgIGltYWdlVXJscy5wdXNoKGAke0JBU0V9L2FybW9yL2NoZXN0LyR7aGVyb0N1c3RvbS5zZXh9LyR7aGVyb0N1c3RvbS5hcm1vcmNoZXN0fS5wbmdgKTtcbiAgICAgICAgaWYgKENoZWNrKGhlcm9DdXN0b20uYXJtb3Jhcm0pKVxuICAgICAgICAgIGltYWdlVXJscy5wdXNoKGAke0JBU0V9L2FybW9yL2FybS8ke2hlcm9DdXN0b20uc2V4fS8ke2hlcm9DdXN0b20uYXJtb3Jhcm19LnBuZ2ApO1xuICAgICAgICBpZiAoQ2hlY2soaGVyb0N1c3RvbS5hcm1vcmxlZ3MpKVxuICAgICAgICAgIGltYWdlVXJscy5wdXNoKGAke0JBU0V9L2FybW9yL2xlZ3MvJHtoZXJvQ3VzdG9tLnNleH0vJHtoZXJvQ3VzdG9tLmFybW9ybGVnc30ucG5nYCk7XG4gICAgICAgIGlmIChDaGVjayhoZXJvQ3VzdG9tLmFybW9yZmVldCkpXG4gICAgICAgICAgaW1hZ2VVcmxzLnB1c2goYCR7QkFTRX0vYXJtb3IvZmVldC8ke2hlcm9DdXN0b20uc2V4fS8ke2hlcm9DdXN0b20uYXJtb3JmZWV0fS5wbmdgKTtcbiAgICAgICAgLy8g5aS05Y+RXG4gICAgICAgIGlmIChDaGVjayhoZXJvQ3VzdG9tLmhhaXIpICYmIENoZWNrKGhlcm9DdXN0b20uaGFpcmNvbG9yKSlcbiAgICAgICAgICBpbWFnZVVybHMucHVzaChgJHtCQVNFfS9oYWlyLyR7aGVyb0N1c3RvbS5zZXh9LyR7aGVyb0N1c3RvbS5oYWlyfS8ke2hlcm9DdXN0b20uaGFpcmNvbG9yfS5wbmdgKTtcbiAgICAgICAgLy8g5aS0XG4gICAgICAgIGlmIChDaGVjayhoZXJvQ3VzdG9tLmhlYWQpKVxuICAgICAgICAgIGltYWdlVXJscy5wdXNoKGAke0JBU0V9L2hlYWQvJHtoZXJvQ3VzdG9tLnNleH0vJHtoZXJvQ3VzdG9tLmhlYWR9LnBuZ2ApO1xuICAgICAgICAvLyDlpLTnm5RcbiAgICAgICAgaWYgKENoZWNrKGhlcm9DdXN0b20uYXJtb3JoZWxtcykpXG4gICAgICAgICAgaW1hZ2VVcmxzLnB1c2goYCR7QkFTRX0vYXJtb3IvaGVsbXMvJHtoZXJvQ3VzdG9tLnNleH0vJHtoZXJvQ3VzdG9tLmFybW9yaGVsbXN9LnBuZ2ApO1xuICAgICAgICAvLyDmrablmajvvIjljIXmi6zmiYDmnInmrablmajvvIlcbiAgICAgICAgaW1hZ2VVcmxzLnB1c2goYCR7QkFTRX0vd2VhcG9ucy8ke2hlcm9DdXN0b20uc2V4fS93ZWFwb25zLnBuZ2ApO1xuICAgICAgfVxuXG4gICAgICBTcHJpdGUubG9hZChpbWFnZVVybHMpLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgQ29tYmluZUhlcm9JbWFnZShkYXRhLCBoZXJvQ3VzdG9tLndpZHRoLCBoZXJvQ3VzdG9tLmhlaWdodCkudGhlbihmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgIHJlc29sdmUoZGF0YSk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG5cblxuICB9KTtcblxuXG59KSgpO1xuIl19
