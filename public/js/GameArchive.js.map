{"version":3,"sources":["src/GameArchive.js"],"names":[],"mappings":"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","file":"src/GameArchive.js","sourcesContent":["/*\n\nA-RPG Game, Built using Node.js + JavaScript + ES6\nCopyright (C) 2015 qhduan(http://qhduan.com)\n\nThis program is free software: you can redistribute it and/or modify\nit under the terms of the GNU General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU General Public License for more details.\n\nYou should have received a copy of the GNU General Public License\nalong with this program.  If not, see <http://www.gnu.org/licenses/>.\n\n*/\n(function () {\n  Game.archive = {};\n\n  Game.archive.remove = function (id) {\n    if (window.localStorage.getItem(id)) {\n      window.localStorage.removeItem(id);\n    }\n  };\n\n  // 返回所有存档，Object格式\n  Game.archive.list = function () {\n    var keys = [];\n    for (var key in window.localStorage) {\n      if (key.match(/^SAVE_(\\d+)$/)) {\n        keys.push(parseInt(key.match(/^SAVE_(\\d+)$/)[1]));\n      }\n    }\n    keys.sort();\n    return keys;\n  };\n\n  // 返回最新存档，Object格式\n  Game.archive.last = function () {\n    var list = Game.archive.list();\n    if (list.length > 0) {\n      var last = list[list.length - 1];\n      return JSON.parse(window.localStorage.getItem(`SAVE_${last}`));\n    } else {\n      throw new Error(\"Game.archive.last Error\");\n    }\n  };\n\n  Game.archive.clear = function () {\n    for (var key in window.localStorage) {\n      if (key.match(/^SAVE_(\\d+)$/)) {\n        window.localStorage.removeItem(key);\n      }\n    }\n  };\n\n  Game.archive.save = function (data) {\n    var now = new Date();\n    var id = now.getTime();\n\n    data.id = id;\n    data.name = data.hero.name;\n    data.date = now.toLocaleString();\n\n    window.localStorage.setItem(`SAVE_${id}`, JSON.stringify(data));\n  };\n\n  Game.archive.get = function (id) {\n    if (id && window.localStorage.getItem(id)) {\n      return JSON.parse(window.localStorage.getItem(id));\n    }\n    return null;\n  };\n\n  Game.archive.load = function (id) {\n    var data = Game.archive.get(id);\n    if (!data) {\n      data = Game.archive.last();\n    }\n\n    if (data) {\n      Game.ShowWindow();\n\n      var heroData = data.hero;\n\n      Game.drawHero(heroData.custom, function (heroImage) {\n        heroData.image = heroImage;\n        Game.hero = new Game.ActorClass(heroData);\n\n        function FindHint () {\n\n          var minDistance = 999999;\n          var minObject = null;\n\n          function FindNearest (obj) {\n            var d = Game.hero.distance(obj.x, obj.y);\n            if (d < minDistance) {\n              minDistance = d;\n              minObject = obj;\n            }\n          }\n\n          // 找最近可“事件”人物 Game.area.actors\n          Sprite.Util.each(Game.area.actors, function (element) {\n            if (element.data.contact) FindNearest(element);\n          });\n\n          // 找最近尸体 Game.area.actors\n          Sprite.Util.each(Game.area.bags, function (element) {\n            FindNearest(element);\n          });\n\n          if (Game.hintObject) {\n            if (Game.hero.distance(Game.hintObject.x, Game.hintObject.y) >= 30) {\n              Game.dialogueLayer.removeChild(Game.hintFlag);\n              Game.hintFlag = null;\n              Game.hintObject = null;\n              if (Game.ui.useButton) {\n                Game.ui.useButton.visible = false;\n              }\n            }\n          }\n\n          if (minObject) {\n            if (minObject != Game.hintObject && minDistance < 50) {\n              Game.hintObject = minObject;\n              if (Game.hintFlag) {\n                Game.dialogueLayer.removeChild(Game.hintFlag);\n                Game.hintFlag = null;\n              }\n              Game.hintFlag = new Sprite.Text({\n                text: \"!\",\n                fontSize: 30,\n                color: \"red\"\n              });\n              Game.hintFlag.x = minObject.x;\n              Game.hintFlag.y = minObject.y;\n              Game.hintFlag.center.x = Math.floor(Game.hintFlag.width/2);\n              Game.hintFlag.center.y = Game.hintFlag.height;\n              Game.dialogueLayer.appendChild(Game.hintFlag);\n              if (Game.ui.useButton) {\n                Game.ui.useButton.visible = true;\n              }\n            }\n          }\n\n        }\n\n        var skip = 0;\n        Sprite.Ticker.on(\"tick\", function () {\n          if (Game.area && Game.area.actors && Game.area.bags) {\n            skip++;\n            if (skip % 5 == 0)\n              FindHint();\n          }\n        });\n\n        //FindHint();\n        Game.hero.on(\"complete\", function () {\n          Game.loadArea(heroData.area, function (area) {\n            Game.area = area;\n            area.map.draw(Game.mapLayer);\n            Game.hero.draw(Game.heroLayer);\n            Game.hero.focus();\n            Game.initInput();\n            Game.ui.init();\n            Game.ShowWindow(\"uiWindow\");\n          });\n        });\n\n      });\n\n    } else {\n      console.error(\"id:\", id);\n      throw \"Invalid id, Game.archive.load\";\n    }\n      //return archive[id];\n\n  };\n})();\n"]}