{"version":3,"sources":["src/Game/GameSkill.js"],"names":[],"mappings":"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","file":"src/Game/GameSkill.js","sourcesContent":["/*\n\nA-RPG Game, Built using JavaScript ES6\nCopyright (C) 2015 qhduan(http://qhduan.com)\n\nThis program is free software: you can redistribute it and/or modify\nit under the terms of the GNU General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU General Public License for more details.\n\nYou should have received a copy of the GNU General Public License\nalong with this program.  If not, see <http://www.gnu.org/licenses/>.\n\n*/\n\n(function () {\n  \"use strict\";\n\n  let internal = Sprite.Namespace();\n\n  Game.assign(\"Skill\", class GameSkill extends Sprite.Event {\n\n    static load (id) {\n      return new Promise(function (resolve, reject) {\n        Sprite.load(`skill/${id}.js`).then(function (data) {\n          let skillData = data[0]();\n          let skillObj = new Game.Skill(skillData);\n          Game.skills[id] = skillObj;\n          skillObj.on(\"complete\", () => {\n            resolve(skillObj);\n          });\n        });\n      });\n    }\n\n    constructor (skillData) {\n      super ();\n      let privates = internal(this);\n      privates.data = skillData;\n\n      Sprite.load(\n        `skill/${this.data.image}`,\n        `skill/${this.data.icon}`,\n        `skill/${this.data.sound}`\n      ).then((data) => {\n        let image = data[0];\n        privates.icon = data[1];\n        privates.sound = data[2];\n\n        let sheet = new Sprite.Sheet({\n          images: [image],\n          width: this.data.tilewidth,\n          height: this.data.tileheight,\n          animations: this.data.animations\n        });\n\n        sheet.centerX = Math.floor(this.data.tilewidth / 2);\n        sheet.centerY = Math.floor(this.data.tileheight / 2);\n\n        if (this.data.alpha) {\n          sheet.alpha = this.data.alpha;\n        }\n\n        privates.sprite = sheet;\n\n        // 发送完成事件，第二个参数代表一次性事件\n        this.emit(\"complete\", true);\n      });\n    }\n\n    get id () {\n      return internal(this).data.id;\n    }\n\n    set id (value) {\n      throw new Error(\"Game.Skill.id readonly\");\n    }\n\n    get icon () {\n      return internal(this).icon;\n    }\n\n    set icon (value) {\n      throw new Error(\"Game.Skill.icon readonly\");\n    }\n\n    get data () {\n      return internal(this).data;\n    }\n\n    set data (value) {\n      console.error(this);\n      throw new Error(\"Game.Skill.data readonly\");\n    }\n\n    get power () {\n      if (Number.isFinite(this.data.power)) {\n        // 固定伤害\n        return this.data.power;\n      } else if (typeof this.data.power == \"string\") {\n        // 骰子伤害，例如1d5就是投一个五面骰子，数值在1到5之间\n        let m = this.data.power.match(/(\\d+)d(\\d+)/);\n        if (!m) {\n          console.error(this.data.power, this.data);\n          throw new Error(\"Sprite.Skill got invalid power data\");\n        }\n        let times = parseInt(m[1]);\n        let dice = parseInt(m[2]);\n        let sum = 0;\n        for (let i = 0; i < times; i++) {\n          sum += Sprite.rand(0, dice) + 1;\n        }\n        return sum;\n      } else {\n        console.error(this.data.power, this.data);\n        throw new Error(\"Game.Skill.power invalid power\");\n      }\n    }\n\n    set power (value) {\n      throw new Error(\"Game.Skill.power readonly\");\n    }\n\n    get type () {\n      return this.data.type;\n    }\n\n    set type (value) {\n      throw new Error(\"Game.Skill.type readonly\");\n    }\n\n    fire (attacker, direction, callback) {\n      let privates = internal(this);\n\n      if (privates.sound) {\n        privates.sound.load();\n        privates.sound.play();\n      }\n\n      let animation = \"attack\" + direction;\n      let weaponAnimation = this.data.animations[animation];\n      let sprite = privates.sprite.clone();\n\n      // 矫正武器效果位置\n      sprite.x = attacker.facePosition.x * 32 + 16;\n      sprite.y = attacker.facePosition.y * 32 + 16;\n\n      // 矫正武器效果中心\n      if (Number.isFinite(weaponAnimation.centerX) && Number.isFinite(weaponAnimation.centerY)) {\n        sprite.centerX = weaponAnimation.centerX;\n        sprite.centerY = weaponAnimation.centerY;\n      } else {\n        console.error(weaponAnimation, this.data);\n        throw new Error(\"Game.Skill.fire invalid centerX/centerY\");\n      }\n\n      // 如果是远距离攻击（this.data.distance > 0），那么distance是它已经走过的距离\n      let distance = 0;\n      // 被命中的actor列表\n      let hitted = [];\n      let CheckHit = () => {\n        // 技能所在当前方格\n        let l1 = Game.area.map.tile(sprite.x, sprite.y);\n        // 碰撞检测\n        for (let actor of Game.area.actors) {\n          if (actor != attacker && hitted.length <= 0) {\n            if (actor.hitTest(l1.x, l1.y)) {\n              hitted.push(actor);\n            }\n          }\n        }\n      };\n\n      let listener = Sprite.Ticker.on(\"tick\", () => {\n\n        if (this.data.distance > 0) {\n          // 飞行速度是4\n          distance += 4;\n        }\n\n        switch (animation) {\n          case \"attackdown\":\n            sprite.y += distance;\n            break;\n          case \"attackleft\":\n            sprite.x -= distance;\n            break;\n          case \"attackright\":\n            sprite.x += distance;\n            break;\n          case \"attackup\":\n            sprite.y -= distance;\n            break;\n        }\n\n        CheckHit();\n\n        // 测试碰撞到墙\n        let grid = Game.area.map.tile(sprite.x, sprite.y);\n        if (Game.area.map.hitTest(grid.x, grid.y)) {\n          Finish();\n        }\n\n        // 如果击中了一个敌人（单体伤害）\n        if (hitted.length > 0) {\n          Finish();\n        }\n\n        // 如果是远程攻击，并且攻击距离已经到了\n        if (this.data.distance > 0 && distance >= this.data.distance) {\n          Finish();\n        }\n\n      });\n\n      // 攻击结束时运行Stop函数\n      let Finish = () => {\n        Sprite.Ticker.off(\"tick\", listener);\n\n        if (hitted.length > 0 && this.data.animations[\"hitted\"]) {\n          let actor = hitted[0];\n          sprite.x = actor.sprite.x;\n          sprite.y = actor.sprite.y;\n          sprite.play(\"hitted\");\n          if (sprite.paused == true) {\n            Game.layers.skillLayer.removeChild(sprite);\n          } else {\n            sprite.on(\"animationend\", function () {\n              Game.layers.skillLayer.removeChild(sprite);\n            });\n          }\n        } else {\n          // 如果动画已经播完，则停止\n          if (sprite.paused == true) {\n            Game.layers.skillLayer.removeChild(sprite);\n          } else {\n            sprite.on(\"animationend\", function () {\n              Game.layers.skillLayer.removeChild(sprite);\n            });\n          }\n        }\n\n        if (callback) {\n          callback(hitted);\n        }\n      }\n\n      Game.layers.skillLayer.appendChild(sprite);\n      sprite.play(animation);\n\n      if ( this.data.animations[animation].actor\n        && attacker.data.animations[this.data.animations[animation].actor] ) {\n        attacker.play(this.data.animations[animation].actor, 3);\n      } else {\n        attacker.play(\"face\" + direction, 0);\n        attacker.play(\"attack\" + direction, 3);\n      }\n    }\n\n  });\n\n})();\n"]}